#!/usr/bin/env cbqn

âŸ¨B2D, _baseâŸ© â† â€¢Import "lib.bqn"

inp â† âˆ¾(Â¯4âŠ¸â†‘2 _base)Â¨"0123456789ABCDEF"âŠâŠ‘â€¢FLines "16.txt"

# Part 1:
ptr â† 0
sum â† 0
RB â† {ptr +â†© ğ•©, inpâŠËœ(ptr-ğ•©)+â†•ğ•©}

GetPkt â† {
  GetPkt aâ€¿bâ€¿c: GetPkt @; # If given a packet value, ignore it.
  GetPkt @: # Read header and redirect to correct packet
  sum +â†© âŠ‘d â† (B2D RB)Â¨ 3â€¿3
  GetPkt d;
  GetPkt vâ€¿4: # normal packet
  val â† B2D {0=âŠ‘RB 1? ğ•©âˆ¾RB 4; ğ•Šğ•©âˆ¾RB 4} âŸ¨âŸ©
  âŸ¨v, 4, valâŸ©; 
  GetPkt vâ€¿t: # operator packet
  data â† {
    âŠ‘RB 1 ? GetPkt âŸ (1+â†•B2D RB 11) @;
	l â† ptr + B2D RB 15
	res â† âŸ¨âŸ©
    {âŠ‘res âˆ¾â†© â‹ˆGetPkt ğ•©} â€¢_while_ {ğ•Š:ptr<l} @
	res
  }
  âŸ¨v, t, dataâŸ©
} 

expr â† GetPkt @
â€¢Show sum

# Part 2:
â€¢Show {
  ğ•Š vâ€¿4â€¿dat: dat;
  ğ•Š vâ€¿tâ€¿dat:
  tâ—¶+â€¿Ã—â€¿âŒŠâ€¿âŒˆâ€¿âŠ¢â€¿>â€¿<â€¿=Â´ğ•ŠÂ¨dat
} expr
